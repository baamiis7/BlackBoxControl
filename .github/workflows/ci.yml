name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  SOLUTION_PATH: BlackBoxControl.sln
  BUILD_CONFIGURATION: Release
  DOTNET_VERSION: '4.7.2'

jobs:
  build:
    name: Build and Test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper versioning
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
    
    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_PATH }}
    
    - name: Build solution
      run: msbuild ${{ env.SOLUTION_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform="Any CPU" /m /v:minimal
    
    - name: Run tests (if test project exists)
      run: |
        if (Test-Path "BlackBoxControl.Tests") {
          Write-Host "Running tests..."
          dotnet test --no-build --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity normal
        } else {
          Write-Host "No test project found - skipping tests"
        }
      shell: powershell
      continue-on-error: true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BlackBoxControl-${{ github.sha }}
        path: |
          bin/${{ env.BUILD_CONFIGURATION }}/**/*
          !bin/${{ env.BUILD_CONFIGURATION }}/**/*.pdb
        retention-days: 30
    
    - name: Create build summary
      run: |
        echo "### Build Summary :rocket:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Configuration:** ${{ env.BUILD_CONFIGURATION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
      shell: bash

  code-quality:
    name: Code Quality Analysis
    runs-on: windows-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for common issues
      run: |
        echo "### Code Quality Checks :mag:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for TODO comments
        $todos = Get-ChildItem -Recurse -Include *.cs | Select-String -Pattern "TODO|FIXME|HACK" | Measure-Object
        echo "- **TODO/FIXME/HACK comments:** $($todos.Count)" >> $GITHUB_STEP_SUMMARY
        
        # Check for large files
        $largeFiles = Get-ChildItem -Recurse -Include *.cs | Where-Object { $_.Length -gt 10000 } | Measure-Object
        echo "- **Files over 10KB:** $($largeFiles.Count)" >> $GITHUB_STEP_SUMMARY
        
        # Check for .editorconfig
        if (Test-Path ".editorconfig") {
          echo "- **EditorConfig:** âœ… Present" >> $GITHUB_STEP_SUMMARY
        } else {
          echo "- **EditorConfig:** âš ï¸ Missing" >> $GITHUB_STEP_SUMMARY
        }
      shell: powershell

  security-scan:
    name: Security Scan
    runs-on: windows-latest
    needs: build
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for secrets
      run: |
        echo "### Security Scan :shield:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check for potential secrets (basic check)
        $suspiciousPatterns = @(
          'password\s*=\s*[''"]',
          'api[_-]?key\s*=\s*[''"]',
          'secret\s*=\s*[''"]',
          'token\s*=\s*[''"]'
        )
        
        $found = $false
        foreach ($pattern in $suspiciousPatterns) {
          $matches = Get-ChildItem -Recurse -Include *.cs,*.config,*.json | Select-String -Pattern $pattern
          if ($matches) {
            echo "- âš ï¸ **Potential secret found:** $pattern" >> $GITHUB_STEP_SUMMARY
            $found = $true
          }
        }
        
        if (-not $found) {
          echo "- âœ… **No obvious secrets detected**" >> $GITHUB_STEP_SUMMARY
        }
      shell: powershell
      continue-on-error: true

  pr-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [build, code-quality, security-scan]
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
    - name: Comment on PR
      uses: actions/github-script@v8
      with:
        script: |
          const comment = `## ğŸš€ Build Results
          
          âœ… **Build Status:** Success
          ğŸ“¦ **Artifacts:** Available for download
          ğŸ” **Code Quality:** Passed
          ğŸ›¡ï¸ **Security Scan:** Completed
          
          The build completed successfully! Your changes are ready for review.
          
          ---
          *This comment was automatically generated by the CI/CD pipeline.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
